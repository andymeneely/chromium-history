{"description":"Make shared memory segments writable only by their rightful owners.\n\nBUG=143859\nTEST=Chrome's UI still works on Linux and Chrome OS\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=158289","cc":["chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"reviewers":["dgozman%chromium.org@gtempaccount.com","BEN@CHROMIUM.ORG","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","jah"],"messages":[{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org"],"text":"PTAL. Thank you!","disapproval":false,"date":"2012-08-21 02:05:27.325280","approval":false},{"sender":"agl@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org"],"text":"The fact that X needs 0666 memory was certainly true in the past. I'm afraid that this needs more investigation. What Linux did you test it on? Did this change with the switch to non-root X, and has that completed on all the platforms we support?","disapproval":false,"date":"2012-08-21 02:14:00.311490","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org"],"text":"On 2012/08/21 02:14:00, agl wrote:\n> The fact that X needs 0666 memory was certainly true in the past. I'm afraid\n> that this needs more investigation. What Linux did you test it on? Did this\n> change with the switch to non-root X, and has that completed on all the\n> platforms we support?\n\nAs mentioned in the bug, gLucid and gPrecise both have X running as root. I did find this:\n\nhttps://wiki.ubuntu.com/X/Rootless\n\nCCing Kees to see if he can tell us what is up. I can't really get a clear story about how widespread/default/well-supported/working this is, from this document.","disapproval":false,"date":"2012-08-30 20:45:05.466910","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org"],"text":"Kees, thoughts about the viability of non-root X, and/or about this patch in general? Thanks.","disapproval":false,"date":"2012-08-30 20:45:43.263650","approval":false},{"sender":"keescook@google.com","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org"],"text":"On 2012/08/30 20:45:43, Chris P. wrote:\n> Kees, thoughts about the viability of non-root X, and/or about this patch in\n> general? Thanks.\n\nMost of the problems with non-root X come in the form of dealing with the input devices sanely. Everything else is ready (mostly due to KMS). Generally, rootless X should work fine, though it's still (obviously) a relatively new way to do things.\n\nAs for this patch, it seems fine, but the comment being removed seems odd to me, like we're overlooking something here. I'm not sure why the 0666 was used -- that seems to have nothing to do with the fact that X with appropriate privs could read an arbitrary shm segment. That seems entirely separate from the mode.\n\nWhat is this shm used for?","disapproval":false,"date":"2012-08-30 22:22:00.290740","approval":false},{"sender":"agl@chromium.org","recipients":["reply@chromiumcodereview.appspotmail.com"],"text":"On Thu, Aug 30, 2012 at 6:22 PM,  <keescook@google.com> wrote:\r\n> What is this shm used for?\r\n\r\nSHM is used so that the renderers can write into a memory segment\r\nthat's shared directly with the X server.\r\n\r\nFar back in the mists of time, X wouldn't attach to a shared memory\r\nsegment that wasn't 0666. That might be superfluous now (or might have\r\nbeen totally bogus then!)\r\n\r\nCheers\r\n\r\nAGL\r\n","disapproval":false,"date":"2012-08-30 22:27:23.301360","approval":false},{"sender":"agl@chromium.org","recipients":["reply@chromiumcodereview-hr.appspotmail.com"],"text":"On Thu, Aug 30, 2012 at 6:22 PM,  <keescook@google.com> wrote:\r\n> What is this shm used for?\r\n\r\nSHM is used so that the renderers can write into a memory segment\r\nthat's shared directly with the X server.\r\n\r\nFar back in the mists of time, X wouldn't attach to a shared memory\r\nsegment that wasn't 0666. That might be superfluous now (or might have\r\nbeen totally bogus then!)\r\n\r\nCheers\r\n\r\nAGL\r\n","disapproval":false,"date":"2012-08-30 22:27:23.583970","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org"],"text":"So the next question is, what UID will non-root X run as? If it runs as the user that runs Chrome, we are solid, and 0600 should work as it does now with root-owned X.\n\nIf X runs as some dedicated third user, say \"xorg\", then X won't be able to write to a shared memory segment owned and writable only by palmer. It sounds like we could \u2014 in principle, and if it turns out to be necessary \u2014 make the segment 0660 and use shmctl(2) to set the GID to xorg's GID.\n\nWe would obviously need some portable way to discover the UID/GID that runs the X process. I don't know what that would be. I am hoping Kees will say \"X runs as the user running Chrome\". :)\n\njln also would like for us to investigate using POSIX IPC instead of Sys V IPC, if that is possible. Can X even handle that? (Obviously that's an issue for another CL, in any case.)","disapproval":false,"date":"2012-08-30 22:35:08.600470","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org"],"text":"CCing jln for thoughts/info.","disapproval":false,"date":"2012-08-30 22:35:31.469950","approval":false},{"sender":"wez@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org"],"text":"FWIW, the access-check appears to be applied to XShmAttach in Xorg here:\n\nhttp://cgit.freedesktop.org/xorg/xserver/tree/Xext/shm.c#n416","disapproval":false,"date":"2012-09-06 23:10:23.852520","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org"],"text":"> FWIW, the access-check appears to be applied to XShmAttach in Xorg here:\n> \n> http://cgit.freedesktop.org/xorg/xserver/tree/Xext/shm.c#n416\n\nThat check appears to succeed \u2014 i.e. access is allowed \u2014 due to massive #ifdef gyrations in GetLocalClientCreds (see http://cgit.freedesktop.org/xorg/xserver/tree/os/access.c). Using DISPLAY=machinename:0, and NX from the host itself and from a remote host, results in XShmAttach success (according to the verbose logging I added).\n\nThe only time XShmAttach fails is when I ssh -X from my Mac to my Linux. That's expected, of course. And Chrome still works in this scenario, it's just slow. Much of the slowness is due to network latency, of course (I am WFH today).\n\nSo I haven't yet seen a scenario in which the reduced permissions causes an XShmAttach failure when it should have succeeded. If anyone can cook one up, I'll try to tweak this patch to first try with 0600 then fall back on 0666 so that in normal scenarios people don't expose their shared memory when they don't have to. If nobody can cook up a plausible failure scenario, then I think this CL should go through.","disapproval":false,"date":"2012-09-07 19:06:21.799100","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"Adding cevans and jorgelo in case they have additional insight.","disapproval":false,"date":"2012-09-07 19:07:07.079480","approval":false},{"sender":"agl@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"lgtm","disapproval":false,"date":"2012-09-07 19:08:07.428850","approval":true},{"sender":"commit-bot@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/palmer@chromium.org/10854242/6006","disapproval":false,"date":"2012-09-07 22:47:54.582840","approval":false},{"sender":"commit-bot@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"Presubmit check for 10854242-6006 failed and returned exit status 1.\n\n\nRunning presubmit commit checks ...\n\n** Presubmit Messages **\nYou might be calling functions intended only for testing from\nproduction code.  It is OK to ignore this warning if you know what\nyou are doing, as the heuristics used to detect the situation are\nnot perfect.  The commit queue will not block on this warning.\nEmail joi@chromium.org if you have questions.\n  ui/base/x/x11_util.cc:1326\n    void InitXKeyEventForTesting(EventType type,\n\n** Presubmit ERRORS **\nMissing LGTM from an OWNER for files in these directories:\n    content/browser/renderer_host\n    ui/surface\n    ui/base/x\n\nPresubmit checks took 1.2s to calculate.","disapproval":false,"date":"2012-09-07 22:48:01.795400","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"Adding kbr for ui/surface/OWNERS\n\nben for content/browser/renderer_host/OWNERS\n\nderat and sadrul for ui/base/x/OWNERS \n\nThank you!","disapproval":false,"date":"2012-09-07 22:54:21.066560","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"Hmm, somehow I failed to actually add kbr and derat. :]","disapproval":false,"date":"2012-09-13 21:38:03.220980","approval":false},{"sender":"kbr@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"LGTM as long as this has been well tested.","disapproval":false,"date":"2012-09-13 21:47:45.770220","approval":true},{"sender":"derat@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"https://codereview.chromium.org/10854242/diff/6006/content/browser/renderer_host/backing_store_gtk.cc\nFile content/browser/renderer_host/backing_store_gtk.cc (right):\n\nhttps://codereview.chromium.org/10854242/diff/6006/content/browser/renderer_host/backing_store_gtk.cc#newcode525\ncontent/browser/renderer_host/backing_store_gtk.cc:525: LOG(WARNING) << \"Failed to get shared memory segment. \"\nHow frequently can this be logged?","disapproval":false,"date":"2012-09-13 22:04:39.732480","approval":false},{"sender":"derat@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"(LGTM if the logging question isn't an issue; just wanted to make sure that we're not logging on every update)","disapproval":false,"date":"2012-09-13 22:36:50.953900","approval":true},{"sender":"commit-bot@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/palmer@chromium.org/10854242/6006","disapproval":false,"date":"2012-09-22 06:35:55.943790","approval":false},{"sender":"commit-bot@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"Presubmit check for 10854242-6006 failed and returned exit status 1.\n\n\nRunning presubmit commit checks ...\n\n** Presubmit Messages **\nYou might be calling functions intended only for testing from\nproduction code.  It is OK to ignore this warning if you know what\nyou are doing, as the heuristics used to detect the situation are\nnot perfect.  The commit queue will not block on this warning.\nEmail joi@chromium.org if you have questions.\n  ui/base/x/x11_util.cc:1398\n    void InitXKeyEventForTesting(EventType type,\n\n** Presubmit ERRORS **\nMissing LGTM from an OWNER for files in these directories:\n    content/browser/renderer_host\n\nPresubmit checks took 1.2s to calculate.","disapproval":false,"date":"2012-09-22 06:36:04.695510","approval":false},{"sender":"palmer@chromium.org","recipients":["palmer@chromium.org","agl@chromium.org","ben@chromium.org","sadrul@chromium.org","kbr@chromium.org","derat@chromium.org","chromium-reviews@chromium.org","sadrul@chromium.org","yusukes+watch@chromium.org","derat+watch@chromium.org","keescook@chromium.org","jln@chromium.org","cevans@chromium.org","jorgelo@chromium.org"],"text":"https://codereview.chromium.org/10854242/diff/6006/content/browser/renderer_host/backing_store_gtk.cc\nFile content/browser/renderer_host/backing_store_gtk.cc (right):\n\nhttps://codereview.chromium.org/10854242/diff/6006/content/browser/renderer_host/backing_store_gtk.cc#newcode525\ncontent/browser/renderer_host/backing_store_gtk.cc:525: LOG(WARNING) << \"Failed to get shared memory segment. \"\n> How frequently can this be logged?\n\nThis one, once. Some of the other logging statements happen more often, but I'd like to leave them for now in case we do hit upon a real-life case where XShmAttach fails during the canary/dev bug shake-out.","disapproval":false,"date":"2012-09-24 16:26:10.912180","approval":false}],"owner_email":"palmer@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src/","owner":"Chromium Palmer","subject":"Make shared memory segments writable only by their rightful owners.","created":"2012-08-21 02:04:34.594020","patchsets":[1,17001,11002,6006],"modified":"2012-09-24 16:27:01.148340","closed":true,"commit":false,"issue":10854242}