{"description":"Ensure that the shared WebRtcAudioRenderer instance gets deleted when not used.\nThis removes the IsLocalRenderer() hack from WebMediaPlayerMS and instead incorporates a per-caller proxy instance that maintains the play and start states for the caller. The underlying WebRtcAudioRenderer instance is then properly stopped and freed when the last WebMediaPlayerMS instance dies.\n\nBUG=288599,276894\nR=xians@chromium.org\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=222528","cc":["chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"reviewers":["xians@chromium.org"],"messages":[{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"","disapproval":false,"date":"2013-09-10 13:11:42.189300","approval":false},{"sender":"xians@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"One more nit besides the start/stop discussion.\n\nhttps://codereview.chromium.org/23444043/diff/1/content/renderer/media/media_stream_impl.cc\nFile content/renderer/media/media_stream_impl.cc (right):\n\nhttps://codereview.chromium.org/23444043/diff/1/content/renderer/media/media_stream_impl.cc#newcode308\ncontent/renderer/media/media_stream_impl.cc:308: scoped_refptr<MediaStreamAudioRenderer>();\nwhy not use NULL? like\nreturn renderer.get() ?\n  renderer->CreateSharedAudioRendererProxy() : NULL;","disapproval":false,"date":"2013-09-10 13:45:09.073170","approval":false},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Add start refcount + fix potential hang during Stop()","disapproval":false,"date":"2013-09-10 14:23:37.883510","approval":false},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Thanks Shijing. Added the start ref counter and also found+fixed a hang issue in Stop().\n\nhttps://codereview.chromium.org/23444043/diff/1/content/renderer/media/media_stream_impl.cc\nFile content/renderer/media/media_stream_impl.cc (right):\n\nhttps://codereview.chromium.org/23444043/diff/1/content/renderer/media/media_stream_impl.cc#newcode308\ncontent/renderer/media/media_stream_impl.cc:308: scoped_refptr<MediaStreamAudioRenderer>();\nOn 2013/09/10 13:45:09, xians1 wrote:\n> why not use NULL? like\n> return renderer.get() ?\n>   renderer->CreateSharedAudioRendererProxy() : NULL;\n\nDone.","disapproval":false,"date":"2013-09-10 14:24:40.245010","approval":false},{"sender":"xians@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"one tiny nit, lgtm\n\nhttps://codereview.chromium.org/23444043/diff/20001/content/renderer/media/webrtc_audio_renderer.cc\nFile content/renderer/media/webrtc_audio_renderer.cc (right):\n\nhttps://codereview.chromium.org/23444043/diff/20001/content/renderer/media/webrtc_audio_renderer.cc#newcode373\ncontent/renderer/media/webrtc_audio_renderer.cc:373: DLOG_IF(ERROR, play_ref_count_) << \"Stop called while still playing.\";\nnit, move this below if (--start_ref_count_) return;","disapproval":false,"date":"2013-09-10 17:57:39.483170","approval":true},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Address comment","disapproval":false,"date":"2013-09-10 21:11:04.123640","approval":false},{"sender":"commit-bot@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/tommi@chromium.org/23444043/42001","disapproval":false,"date":"2013-09-10 21:14:53.468480","approval":false},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"https://codereview.chromium.org/23444043/diff/20001/content/renderer/media/webrtc_audio_renderer.cc\nFile content/renderer/media/webrtc_audio_renderer.cc (right):\n\nhttps://codereview.chromium.org/23444043/diff/20001/content/renderer/media/webrtc_audio_renderer.cc#newcode373\ncontent/renderer/media/webrtc_audio_renderer.cc:373: DLOG_IF(ERROR, play_ref_count_) << \"Stop called while still playing.\";\nOn 2013/09/10 17:57:39, xians1 wrote:\n> nit, move this below if (--start_ref_count_) return;\n\nDone. I decided just to remove it since we're already doing that in webmediaplayer_ms.","disapproval":false,"date":"2013-09-10 21:18:10.017240","approval":false},{"sender":"commit-bot@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Retried try job too often on mac_rel for step(s) content_unittests\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=mac_rel&number=167702","disapproval":false,"date":"2013-09-10 22:32:45.344990","approval":false},{"sender":"commit-bot@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/tommi@chromium.org/23444043/42001","disapproval":false,"date":"2013-09-11 04:49:29.259900","approval":false},{"sender":"commit-bot@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Retried try job too often on mac_rel for step(s) content_unittests\nhttp://build.chromium.org/p/tryserver.chromium/buildstatus?builder=mac_rel&number=167842","disapproval":false,"date":"2013-09-11 05:41:41.007150","approval":false},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Update tests to use the proxy and add more DCHECKs","disapproval":false,"date":"2013-09-11 07:07:10.476320","approval":false},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Two more DCHECKs","disapproval":false,"date":"2013-09-11 07:13:39.712520","approval":false},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Hey Shijing - the unit tests were failing on Mac so I fixed them.  The test code wasn't calling Start() so I also added DCHECKs to Play/Pause that Start() had been called.  To prevent code from using the renderer object directly (no proxy), I also made the overridden methods private.\nSince the renderer is now stopped automatically I removed the cleanup code in WebRtcAudioDeviceImpl::Terminate and instead DCHECK that the state is correct.\nPTAL.","disapproval":false,"date":"2013-09-11 07:15:12.801400","approval":false},{"sender":"xians@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"just one comment but no better proposal, lgtm again.\n\nhttps://codereview.chromium.org/23444043/diff/12001/content/renderer/media/webrtc_audio_device_impl.cc\nFile content/renderer/media/webrtc_audio_device_impl.cc (right):\n\nhttps://codereview.chromium.org/23444043/diff/12001/content/renderer/media/webrtc_audio_device_impl.cc#newcode201\ncontent/renderer/media/webrtc_audio_device_impl.cc:201: DCHECK(!renderer_.get() || !renderer_->IsStarted())\nthis WebRtcAudioDeviceImpl is a source to the renderer, so it has to outlive the renderer.\nI am fine to have a DCHECK here instead of calling Stop() if you are confident the webkit mediaplayers will go away before WebRtcAudioDeviceImpl.","disapproval":false,"date":"2013-09-11 12:37:28.996780","approval":true},{"sender":"tommi@chromium.org","recipients":["tommi@chromium.org","xians@chromium.org","chromium-reviews@chromium.org","joi+watch-content@chromium.org","feature-media-reviews@chromium.org","jam@chromium.org","darin-cc@chromium.org"],"text":"Committed patchset #5 manually as r222528 (presubmit successful).","disapproval":false,"date":"2013-09-11 13:28:01.550220","approval":false}],"owner_email":"tommi@chromium.org","private":false,"base_url":"http://git.chromium.org/chromium/src.git@master","owner":"tommi","subject":"Ensure that the shared WebRtcAudioRenderer instance gets deleted when not used.","created":"2013-09-10 13:11:18.511470","patchsets":[1,20001,42001,62001,12001],"modified":"2013-09-11 13:28:01.910060","closed":true,"commit":false,"issue":23444043}