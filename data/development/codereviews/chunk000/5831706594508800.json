{"description":"cc: Cleanup Layer::SetNeedsDisplayInRect\n\nThis comment is no longer true.  Also, simplified the early out\ncondition and added a test.\n\nR=danakj@chromium.org\nBUG=none\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=214103\n\nCommitted: https://src.chromium.org/viewvc/chrome?view=rev&revision=214819","cc":["chromium-reviews@chromium.org","cc-bugs@chromium.org"],"reviewers":["danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org"],"messages":[{"sender":"enne@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"","disapproval":false,"date":"2013-07-11 21:25:52.663640","approval":false},{"sender":"danakj@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"LGTM","disapproval":false,"date":"2013-07-11 21:28:51.445960","approval":true},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/enne@chromium.org/5831706594508800/5629499534213120","disapproval":false,"date":"2013-07-11 21:33:52.734670","approval":false},{"sender":"skaslev@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"https://codereview.chromium.org/5831706594508800/diff/5629499534213120/cc/layers/layer.cc\nFile cc/layers/layer.cc (right):\n\nhttps://codereview.chromium.org/5831706594508800/diff/5629499534213120/cc/layers/layer.cc#newcode623\ncc/layers/layer.cc:623: if (dirty_rect.IsEmpty())\nDon't do this. When I wrote that function, the intended semantics was that dirty_rect will be appended to the region that need update. Passing empty rect still should issue a commit.\n\nSee \nhttps://code.google.com/p/chromium/codesearch#chromium/src/ui/views/widget/desktop_aura/desktop_root_window_host_win.cc&q=ui/views/widget/desktop_aura/desktop_root_window_host_win.cc&sq=package:chromium&l=824\nfor example of such usage.","disapproval":false,"date":"2013-07-11 21:58:09.221810","approval":false},{"sender":"danakj@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"https://codereview.chromium.org/5831706594508800/diff/5629499534213120/cc/layers/layer.cc\nFile cc/layers/layer.cc (right):\n\nhttps://codereview.chromium.org/5831706594508800/diff/5629499534213120/cc/layers/layer.cc#newcode623\ncc/layers/layer.cc:623: if (dirty_rect.IsEmpty())\nOn 2013/07/11 21:58:09, slavi wrote:\n> Don't do this. When I wrote that function, the intended semantics was that\n> dirty_rect will be appended to the region that need update. Passing empty rect\n> still should issue a commit.\n> \n> See \n> https://code.google.com/p/chromium/codesearch#chromium/src/ui/views/widget/desktop_aura/desktop_root_window_host_win.cc&q=ui/views/widget/desktop_aura/desktop_root_window_host_win.cc&sq=package:chromium&l=824\n> for example of such usage.\n\nWhy not just call SetNeedsCommit on the layer's host?","disapproval":false,"date":"2013-07-11 21:59:12.685390","approval":false},{"sender":"enne@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"Without passing a valid dirty rect, how is that code correct during partial swap?\n\nWhat's the use case where you need a commit without damage?","disapproval":false,"date":"2013-07-11 22:06:09.760120","approval":false},{"sender":"skaslev@google.com","recipients":["reply@chromiumcodereview-hr.appspotmail.com"],"text":"I don't remember the details anymore. I can refer you to the example in the\r\ncs link I sent or just trace callers with empty rects in the browser\r\ncompositor. The point was that if you want to change the semantics of\r\ncalling this function with empty rects, you might also have to track down\r\nthe callers that pass empty rects as a request for redraw.\r\n\r\n\r\nOn Thu, Jul 11, 2013 at 3:06 PM, <enne@chromium.org> wrote:\r\n\r\n> Without passing a valid dirty rect, how is that code correct during partial\r\n> swap?\r\n>\r\n> What's the use case where you need a commit without damage?\r\n>\r\n> https://codereview.chromium.**org/5831706594508800/<https://codereview.chromium.org/5831706594508800/>\r\n>\r\n\r\n\r\n\r\n-- \r\nSlavomir Kaslev | Software Engineer | skaslev@google.com | 562 217 8497\r\n","disapproval":false,"date":"2013-07-12 00:32:04.770480","approval":false},{"sender":"enne@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"skaslev: How does that code even get called with a compositor? It looks like every caller calls HandlePaintAccelerated (which passes a dirty rect) first before calling HandlePaint (which just passes a canvas), e.g. https://code.google.com/p/chromium/codesearch#chromium/src/ui/views/win/hwnd_message_handler.cc&l=1858.\n\nI know very little about this code, but I'm having a hard time seeing what you're worried about.  Do you have more examples?","disapproval":false,"date":"2013-07-24 00:52:01.136560","approval":false},{"sender":"tomhudson@google.com","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"https://codereview.chromium.org/5831706594508800/diff/5629499534213120/cc/layers/layer.cc\nFile cc/layers/layer.cc (right):\n\nhttps://codereview.chromium.org/5831706594508800/diff/5629499534213120/cc/layers/layer.cc#newcode623\ncc/layers/layer.cc:623: if (dirty_rect.IsEmpty())\nOn 2013/07/11 21:58:09, slavi wrote:\n> Don't do this. When I wrote that function, the intended semantics was that\n> dirty_rect will be appended to the region that need update. Passing empty rect\n> still should issue a commit.\n\nIf people can't determine the intended semantics by reading the code, do we need to add comments? Or more descriptive naming?","disapproval":false,"date":"2013-07-24 09:02:42.924460","approval":false},{"sender":"enne@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"I do not think that the code that skaslev points out can make it to the compositor.  Even if it did, we would commit and not draw because of the no damage early out.  So, I do not believe that anything can actually be relying on this logic.\n\nI'm going to commit this and will deal with any fallout, if any.","disapproval":false,"date":"2013-07-24 19:07:14.521960","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/enne@chromium.org/5831706594508800/5629499534213120","disapproval":false,"date":"2013-07-24 19:11:24.474590","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/enne@chromium.org/5831706594508800/5629499534213120","disapproval":false,"date":"2013-07-25 15:22:48.150690","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/enne@chromium.org/5831706594508800/5629499534213120","disapproval":false,"date":"2013-07-26 03:11:22.388890","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"Change committed as 214103","disapproval":false,"date":"2013-07-28 08:34:47.489270","approval":false},{"sender":"ojan@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"Looks like this patch caused regressions: https://code.google.com/p/chromium/issues/detail?id=265258","disapproval":false,"date":"2013-07-28 18:23:19.810340","approval":false},{"sender":"senorblanco@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"On 2013/07/28 18:23:19, ojan wrote:\n> Looks like this patch caused regressions:\n> https://code.google.com/p/chromium/issues/detail?id=265258\n\nYep, I verified this change locally as the culprit, and rolled out in r214163.","disapproval":false,"date":"2013-07-29 06:37:26.226510","approval":false},{"sender":"enne@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"danakj: Take two.  PTAL.\n\nhttps://codereview.chromium.org/5831706594508800/diff/54001/cc/layers/image_layer.cc\nFile cc/layers/image_layer.cc (right):\n\nhttps://codereview.chromium.org/5831706594508800/diff/54001/cc/layers/image_layer.cc#newcode46\ncc/layers/image_layer.cc:46: if (!updater_->UsingBitmap(bitmap_)) {\nThe reason this code was broken before was that ImageLayer::SetBitmap above was calling SetNeedsDisplay() when the bounds of the layer was empty.  This prevented needs_display_ from getting set to true, causing the tile size to not be updated in this conditional.  The tile size being zero means that we were requesting shared memory of size zero which blew up.\n\nThis code is really trying to check that the bitmap has changed, and so check this explicitly.  It's also a little sketchy that it was unsetting needs_display_ here.\n\nhttps://codereview.chromium.org/5831706594508800/diff/54001/cc/layers/nine_patch_layer.cc\nFile cc/layers/nine_patch_layer.cc (right):\n\nhttps://codereview.chromium.org/5831706594508800/diff/54001/cc/layers/nine_patch_layer.cc#newcode36\ncc/layers/nine_patch_layer.cc:36: } else if (bitmap_dirty_ && DrawsContent()) {\nNinePatchLayer also uses image layer updaters and was the only other layer type checking needs_display_ for similar reasons when setting the bitmap.  bitmap_dirty_ is redundant with needs_display_ here and so can be removed.","disapproval":false,"date":"2013-07-30 20:01:27.065410","approval":false},{"sender":"danakj@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"LGTM\n\nSeems like NinePatchLayer could remove bitmap_dirty_ and use your new IsUsingBitmap method as well.","disapproval":false,"date":"2013-07-31 01:19:07.972460","approval":true},{"sender":"enne@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"On 2013/07/31 01:19:07, danakj wrote:\n\n> Seems like NinePatchLayer could remove bitmap_dirty_ and use your new\n> IsUsingBitmap method as well.\n\nI thought about that, but NinePatchLayer uses bitmap_dirty_ in both SetTexturePriorities (to create the resource) and in Update (to queue its upload), so it wasn't as simple to remove.  ImageLayer doesn't need a separate variable because TiledLayer handles the upload implicitly because of the invalidations.","disapproval":false,"date":"2013-07-31 02:30:56.439560","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/enne@chromium.org/5831706594508800/54001","disapproval":false,"date":"2013-07-31 02:52:47.619840","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"Failed to apply patch for cc/layers/layer.cc:\nWhile running patch -p1 --forward --force --no-backup-if-mismatch;\n  patching file cc/layers/layer.cc\n  Hunk #1 FAILED at 663.\n  1 out of 1 hunk FAILED -- saving rejects to file cc/layers/layer.cc.rej\n\nPatch:       cc/layers/layer.cc\nIndex: cc/layers/layer.cc\ndiff --git a/cc/layers/layer.cc b/cc/layers/layer.cc\nindex 5e7bd77ecc9ee5fa31359d0d78e6980f529f7fc3..fc9f2daba445f1b78b01dc5a3c2624a620663b95 100644\n--- a/cc/layers/layer.cc\n+++ b/cc/layers/layer.cc\n@@ -663,13 +663,13 @@ void Layer::SetHideLayerAndSubtree(bool hide) {\n }\n \n void Layer::SetNeedsDisplayRect(const gfx::RectF& dirty_rect) {\n+  if (dirty_rect.IsEmpty())\n+    return;\n+\n   update_rect_.Union(dirty_rect);\n   needs_display_ = true;\n \n-  // Simply mark the contents as dirty. For non-root layers, the call to\n-  // SetNeedsCommit will schedule a fresh compositing pass.\n-  // For the root layer, SetNeedsCommit has no effect.\n-  if (DrawsContent() && !update_rect_.IsEmpty())\n+  if (DrawsContent())\n     SetNeedsCommit();\n }","disapproval":false,"date":"2013-07-31 02:52:53.754970","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"CQ is trying da patch. Follow status at\nhttps://chromium-status.appspot.com/cq/enne@chromium.org/5831706594508800/67001","disapproval":false,"date":"2013-07-31 17:31:16.450590","approval":false},{"sender":"commit-bot@chromium.org","recipients":["enne@chromium.org","danakj@chromium.org","skaslev@chromium.org","skaslev@google.com","ojan@chromium.org","chromium-reviews@chromium.org","cc-bugs@chromium.org"],"text":"Change committed as 214819","disapproval":false,"date":"2013-07-31 20:20:26.858710","approval":false}],"owner_email":"enne@chromium.org","private":false,"base_url":"svn://svn.chromium.org/chrome/trunk/src","owner":"enne","subject":"cc: Cleanup Layer::SetNeedsDisplayInRect","created":"2013-07-11 21:25:50.493370","patchsets":[5629499534213120,51001,54001,67001],"modified":"2013-07-31 20:20:27.173790","closed":true,"commit":false,"issue":5831706594508800}