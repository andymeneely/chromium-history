{"files":{"media/audio/test_audio_input_controller_factory.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":2,"messages":[],"id":7062,"is_binary":false},"media/tools/player_wtl/movie.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":3,"num_removed":1,"messages":[],"id":7070,"is_binary":false},"media/filters/reference_audio_renderer.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":3,"messages":[],"id":7067,"is_binary":false},"content/browser/resource_context.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":18,"num_removed":1,"messages":[{"author":"willchan","author_email":"willchan@chromium.org","text":"Can you explain this comment? When is AudioManager initialized then? And why isn't there a DCHECK(BrowserThread::CurrentlyOn(BrowserThread::IO))?","draft":false,"lineno":184,"date":"2011-12-06 17:02:12.738057","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/06 17:02:12, willchan wrote:\n> Can you explain this comment? When is AudioManager initialized then? And why\n> isn't there a DCHECK(BrowserThread::CurrentlyOn(BrowserThread::IO))?\n\nSorry, this comment isn't correct. I must have forgotten to update it since an early version of the cl.  I'll fix it.\n\nWhen Chrome runs, the audio manager instance is created and owned by the BrowserProcessImpl class.  This always happens on the IO thread and (as you no doubt know) there is a check inside EnsureInitialized() for that.\nWhat's different here though, and the reason why there isn't a dcheck here like with the other accessors, is that the audio_manager accessor can be called on other threads than the IO thread.  I suspect that the reason for this is historical since the AudioManager was a singleton with an undefined threading model and anyone could call the instance method at any time and on any thread.\n","draft":false,"lineno":184,"date":"2011-12-06 20:28:48.638385","left":false},{"author":"willchan","author_email":"willchan@chromium.org","text":"On 2011/12/06 20:28:48, tommi wrote:\n> On 2011/12/06 17:02:12, willchan wrote:\n> > Can you explain this comment? When is AudioManager initialized then? And why\n> > isn't there a DCHECK(BrowserThread::CurrentlyOn(BrowserThread::IO))?\n> \n> Sorry, this comment isn't correct. I must have forgotten to update it since an\n> early version of the cl.  I'll fix it.\n> \n> When Chrome runs, the audio manager instance is created and owned by the\n> BrowserProcessImpl class.  This always happens on the IO thread and (as you no\n> doubt know) there is a check inside EnsureInitialized() for that.\n> What's different here though, and the reason why there isn't a dcheck here like\n> with the other accessors, is that the audio_manager accessor can be called on\n> other threads than the IO thread.  I suspect that the reason for this is\n> historical since the AudioManager was a singleton with an undefined threading\n> model and anyone could call the instance method at any time and on any thread.\n\nI see. While it's not strictly a problem, it's different from the existing threading model and we should be careful here. ResourceContext is created and owned by ProfileIOData, which will be deleted on the IO thread and thus ResourceContext will get deleted on the IO thread. We need to think carefully about the shutdown case here. Note the shutdown order indicated by http://codesearch.google.com/codesearch#OAMlx_jo-ck/src/content/public/browser/browser_thread.h&exact_package=chromium&q=browser_thread.h&type=cs&l=56. If ResourceContext is used on any thread which outlasts the IO thread, then we have a problem, because ResourceContext may be deleted, and we'll get a use after free.\n\nThis is the reason we have always just forced the accessors to be non-threadsafe and only accessible on the IO thread.","draft":false,"lineno":184,"date":"2011-12-07 15:29:20.381932","left":false}],"id":7024,"is_binary":false},"media/audio/audio_output_dispatcher.cc":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":38,"num_removed":8,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"Not sure why this is needed.","draft":false,"lineno":22,"date":"2011-12-07 10:08:34.505579","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Not sure why this is needed.\n\nIt allows |this| to be used in an initializer list without a warning when you know it is safe to do so.  For more details: http://msdn.microsoft.com/en-us/library/3c594ae3(VS.80).aspx","draft":false,"lineno":22,"date":"2011-12-07 12:26:44.225390","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"I meant the weak pointer.","draft":false,"lineno":22,"date":"2011-12-07 12:48:01.233680","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 12:48:01, henrika1 wrote:\n> I meant the weak pointer.\n\nAh.  Here's the comment from the header file:\n\n  // Used to post delayed tasks to ourselves that we can cancel.\n  base::WeakPtrFactory<AudioOutputDispatcher> weak_this_;\n\nThis is important as if we do not do this, the message queue can hold onto the the object and cause the stream objects (and held resources) to be not be deleted at all if MessageLoop::DeletePendingTasks is called and/or cause the object to be deleted at a point in time that's not guaranteed to always be the same, which doesn't have any benefits but is harder to test and debug.\n\nAs a side note, the AudioOutputDispatcher class doesn't really need to be reference counted. Things would be simpler if it wasn't.  Perhaps I can do that refactoring job on a later cl.","draft":false,"lineno":22,"date":"2011-12-07 14:46:23.993994","left":false}],"id":7049,"is_binary":false},"media/audio/test_audio_input_controller_factory.h":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":2,"num_removed":0,"messages":[],"id":7063,"is_binary":false},"chrome/browser/speech/chrome_speech_input_manager.cc":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":13,"num_removed":4,"messages":[],"id":7007,"is_binary":false},"chrome/test/base/testing_browser_process.h":{"status":"M    ","num_chunks":1,"no_base_file":false,"property_changes":"","num_added":1,"num_removed":0,"messages":[],"id":7012,"is_binary":false},"media/tools/player_x11/player_x11.cc":{"status":"M    ","num_chunks":8,"no_base_file":false,"property_changes":"","num_added":18,"num_removed":7,"messages":[],"id":7071,"is_binary":false},"content/browser/renderer_host/media/audio_input_device_manager.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":3,"messages":[],"id":7013,"is_binary":false},"media/audio/audio_manager.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":24,"num_removed":20,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"nit, indent two more?","draft":false,"lineno":24,"date":"2011-12-07 10:08:34.503618","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"Still a valid comment?","draft":false,"lineno":39,"date":"2011-12-07 10:08:34.503912","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> nit, indent two more?\n\nDone.","draft":false,"lineno":24,"date":"2011-12-07 12:26:44.223886","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Still a valid comment?\nNope. Removed.\n","draft":false,"lineno":39,"date":"2011-12-07 12:26:44.224040","left":false}],"id":7043,"is_binary":false},"media/filters/reference_audio_renderer.h":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":6,"num_removed":3,"messages":[],"id":7068,"is_binary":false},"content/browser/renderer_host/media/video_capture_host_unittest.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":6,"num_removed":1,"messages":[],"id":7022,"is_binary":false},"media/audio/audio_output_proxy_unittest.cc":{"status":"M    ","num_chunks":12,"no_base_file":false,"property_changes":"","num_added":19,"num_removed":13,"messages":[],"id":7053,"is_binary":false},"media/audio/audio_output_controller.h":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":10,"num_removed":2,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"Can you add some more details on why you had to introduce this pattern. It is not obvious why it is required. Perhaps add some extended comments in this area in the actual header?","draft":false,"lineno":247,"date":"2011-12-07 10:08:34.505094","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Can you add some more details on why you had to introduce this pattern. It is\n> not obvious why it is required. Perhaps add some extended comments in this area\n> in the actual header?\n\nImproved comment.","draft":false,"lineno":247,"date":"2011-12-07 12:26:44.225167","left":false}],"id":7047,"is_binary":false},"chrome/browser/profiles/profile_io_data.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":3,"num_removed":1,"messages":[],"id":7006,"is_binary":false},"media/audio/mac/audio_low_latency_input_mac_unittest.cc":{"status":"M    ","num_chunks":8,"no_base_file":false,"property_changes":"","num_added":48,"num_removed":45,"messages":[],"id":7059,"is_binary":false},"chrome/browser/speech/speech_input_bubble_gtk.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":12,"num_removed":6,"messages":[],"id":7008,"is_binary":false},"media/audio/audio_manager.cc":{"status":"M    ","num_chunks":1,"no_base_file":false,"property_changes":"","num_added":20,"num_removed":24,"messages":[],"id":7042,"is_binary":false},"media/audio/simple_sources_unittest.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":2,"num_removed":3,"messages":[],"id":7061,"is_binary":false},"chrome/browser/speech/speech_input_extension_manager.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":8,"num_removed":7,"messages":[],"id":7010,"is_binary":false},"media/audio/audio_output_controller.cc":{"status":"M    ","num_chunks":9,"no_base_file":false,"property_changes":"","num_added":33,"num_removed":34,"messages":[],"id":7046,"is_binary":false},"content/browser/renderer_host/media/audio_renderer_host.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":10,"num_removed":5,"messages":[],"id":7017,"is_binary":false},"media/audio/audio_output_dispatcher.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":9,"num_removed":2,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"Nit, empty line above comment.","draft":false,"lineno":101,"date":"2011-12-07 10:08:34.505831","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Nit, empty line above comment.\n\nDone.","draft":false,"lineno":101,"date":"2011-12-07 12:26:44.225621","left":false}],"id":7050,"is_binary":false},"chrome/browser/speech/speech_input_bubble_views.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":1,"messages":[],"id":7009,"is_binary":false},"content/browser/resource_context.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":0,"messages":[],"id":7025,"is_binary":false},"content/test/webrtc_audio_device_test.cc":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":59,"num_removed":24,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"the","draft":false,"lineno":131,"date":"2011-12-07 10:26:43.842390","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:26:43, henrika1 wrote:\n> the\n\nCan you clarify?","draft":false,"lineno":131,"date":"2011-12-07 12:26:44.223633","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"\"..by closing *the* channel.\"","draft":false,"lineno":131,"date":"2011-12-07 12:48:01.233426","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 12:48:01, henrika1 wrote:\n> \"..by closing *the* channel.\"\nah. sorry, refrigerator blindness. Done.\n","draft":false,"lineno":131,"date":"2011-12-07 14:46:23.993707","left":false}],"id":7035,"is_binary":false},"content/browser/speech/speech_recognizer.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":0,"messages":[],"id":7032,"is_binary":false},"content/browser/renderer_host/media/audio_input_device_manager_unittest.cc":{"status":"M    ","num_chunks":9,"no_base_file":false,"property_changes":"","num_added":35,"num_removed":17,"messages":[],"id":7015,"is_binary":false},"content/browser/speech/speech_input_manager.cc":{"status":"M    ","num_chunks":7,"no_base_file":false,"property_changes":"","num_added":24,"num_removed":13,"messages":[],"id":7029,"is_binary":false},"media/audio/linux/alsa_output_unittest.cc":{"status":"M    ","num_chunks":13,"no_base_file":false,"property_changes":"","num_added":18,"num_removed":13,"messages":[],"id":7056,"is_binary":false},"media/audio/linux/audio_manager_linux.cc":{"status":"M    ","num_chunks":4,"no_base_file":false,"property_changes":"","num_added":13,"num_removed":20,"messages":[],"id":7057,"is_binary":false},"media/audio/audio_output_proxy.h":{"status":"M    ","num_chunks":4,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":7,"messages":[],"id":7052,"is_binary":false},"content/test/webrtc_audio_device_test.h":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":17,"messages":[],"id":7036,"is_binary":false},"media/audio/win/audio_low_latency_output_win_unittest.cc":{"status":"M    ","num_chunks":16,"no_base_file":false,"property_changes":"","num_added":49,"num_removed":32,"messages":[],"id":7065,"is_binary":false},"chrome/browser/browser_process.h":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":3,"num_removed":0,"messages":[],"id":7003,"is_binary":false},"media/audio/audio_input_controller.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":14,"num_removed":11,"messages":[],"id":7037,"is_binary":false},"chrome/browser/browser_process_impl.h":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":3,"num_removed":0,"messages":[],"id":7005,"is_binary":false},"media/tools/player_wtl/movie.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":2,"messages":[],"id":7069,"is_binary":false},"content/browser/renderer_host/media/audio_renderer_host_unittest.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":22,"num_removed":6,"messages":[],"id":7018,"is_binary":false},"content/browser/speech/speech_input_browsertest.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":21,"num_removed":27,"messages":[],"id":7026,"is_binary":false},"content/browser/renderer_host/media/audio_input_renderer_host.cc":{"status":"M    ","num_chunks":1,"no_base_file":false,"property_changes":"","num_added":1,"num_removed":0,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"Do we need the full resource context here or can we inject only the manager instead?","draft":false,"lineno":249,"date":"2011-12-07 10:26:43.841986","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:26:43, henrika1 wrote:\n> Do we need the full resource context here or can we inject only the manager\n> instead?\n\nOnly the manager is being injected... am I misunderstanding?","draft":false,"lineno":249,"date":"2011-12-07 12:26:44.223248","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"Sorry, I had this question in my head from another file. Please ignore.","draft":false,"lineno":249,"date":"2011-12-07 12:48:01.233154","left":false}],"id":7016,"is_binary":false},"media/audio/audio_output_controller_unittest.cc":{"status":"M    ","num_chunks":16,"no_base_file":false,"property_changes":"","num_added":55,"num_removed":22,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"So much nicer to inject the manager here. All magic is now gone ;-) Thanks!","draft":false,"lineno":104,"date":"2011-12-07 10:08:34.505334","left":false}],"id":7048,"is_binary":false},"media/audio/audio_input_controller_unittest.cc":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":10,"num_removed":5,"messages":[],"id":7039,"is_binary":false},"media/audio/audio_manager_base.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":17,"num_removed":10,"messages":[],"id":7045,"is_binary":false},"content/renderer/media/webrtc_audio_device_unittest.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":6,"num_removed":39,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"You will get a comment from Andrew on this one ;-)","draft":false,"lineno":352,"date":"2011-12-07 10:26:43.842217","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:26:43, henrika1 wrote:\n> You will get a comment from Andrew on this one ;-)\n\nAh, yes.  So, I might as well preemptively answer :)\n\nPreviously, the timeout was by default 10 seconds.  This timeout is an 'action timeout' and it was me that originally put it there.  However, I don't think that applying that timeout to an audio stream of a fixed length, and not an action, is the right use of that timer.  We should rather use a fixed timeout.\nSo, the question becomes, how long should the timeout be?\nI picked 2 seconds as random.  Perhaps I should rather pick 500ms as is done in the WinAudioTest tests, which also play audio (see e.g. PCMWaveStreamPlay200HzTone44Kss)?","draft":false,"lineno":352,"date":"2011-12-07 12:26:44.223436","left":false}],"id":7034,"is_binary":false},"chrome/test/base/testing_browser_process.cc":{"status":"M    ","num_chunks":1,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":0,"messages":[],"id":7011,"is_binary":false},"content/browser/renderer_host/media/audio_input_device_manager.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":1,"messages":[],"id":7014,"is_binary":false},"content/browser/speech/speech_input_manager.h":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":3,"num_removed":2,"messages":[],"id":7030,"is_binary":false},"media/audio/linux/alsa_input.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":1,"messages":[],"id":7055,"is_binary":false},"media/audio/win/audio_output_win_unittest.cc":{"status":"M    ","num_chunks":17,"no_base_file":false,"property_changes":"","num_added":26,"num_removed":37,"messages":[],"id":7066,"is_binary":false},"media/audio/mac/audio_output_mac_unittest.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":7,"num_removed":11,"messages":[],"id":7060,"is_binary":false},"media/audio/audio_input_unittest.cc":{"status":"M    ","num_chunks":6,"no_base_file":false,"property_changes":"","num_added":24,"num_removed":20,"messages":[],"id":7041,"is_binary":false},"media/audio/win/audio_low_latency_input_win_unittest.cc":{"status":"M    ","num_chunks":10,"no_base_file":false,"property_changes":"","num_added":34,"num_removed":24,"messages":[],"id":7064,"is_binary":false},"chrome/browser/browser_process_impl.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":9,"num_removed":0,"messages":[],"id":7004,"is_binary":false},"media/audio/audio_input_controller.h":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":10,"num_removed":3,"messages":[],"id":7038,"is_binary":false},"media/audio/audio_input_device_unittest.cc":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":14,"num_removed":34,"messages":[],"id":7040,"is_binary":false},"media/audio/linux/alsa_input.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":6,"num_removed":6,"messages":[],"id":7054,"is_binary":false},"content/browser/speech/speech_input_dispatcher_host.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":8,"num_removed":4,"messages":[],"id":7027,"is_binary":false},"content/browser/speech/speech_input_dispatcher_host.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":4,"num_removed":1,"messages":[],"id":7028,"is_binary":false},"content/browser/speech/speech_recognizer.cc":{"status":"M    ","num_chunks":4,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":2,"messages":[],"id":7031,"is_binary":false},"media/audio/audio_manager_base.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":60,"num_removed":19,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"Please add some comments here to explain the purpose of your checks. Thanks.","draft":false,"lineno":25,"date":"2011-12-07 10:08:34.504206","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"Any point in checking Initialized() here to ensure that the thread is running?","draft":false,"lineno":40,"date":"2011-12-07 10:08:34.504477","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"Nice!","draft":false,"lineno":77,"date":"2011-12-07 10:08:34.504716","left":false},{"author":"henrika","author_email":"henrika@chromium.org","text":"Can you add some more information here please. You post a task on the audio thread and then closes the same thread directly after. Even if your design works; is it a good design? To me it feels a bit advanced. Can't it be simplified or can you use any alternative method? If not, why?","draft":false,"lineno":100,"date":"2011-12-07 10:08:34.504891","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Please add some comments here to explain the purpose of your checks. Thanks.\nThere are comments in the header.  Please let me know if they're not clear enough.\n","draft":false,"lineno":25,"date":"2011-12-07 12:26:44.224232","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Any point in checking Initialized() here to ensure that the thread is running?\naudio_thread_.Start() returns true iff the thread is running.\n","draft":false,"lineno":40,"date":"2011-12-07 12:26:44.224463","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Nice!\nThanks! :)\n","draft":false,"lineno":77,"date":"2011-12-07 12:26:44.224677","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Can you add some more information here please. You post a task on the audio\n> thread and then closes the same thread directly after. Even if your design\n> works; is it a good design? To me it feels a bit advanced. Can't it be\n> simplified or can you use any alternative method? If not, why?\n\nWell, this is how the Thread class works, fine or not :) You'll see this pattern all over chrome where the thread class is used - including inside the implementation of Thread::Stop().  As the comment explains, Stop() will not return until all pending messages have been processed, including the one we just posted.\n\nRegarding an alternative method, I'm not sure if you mean 1) an alternative method of waiting for ShutdownOnAudioThread to complete or if 2) we can somehow differently uninitialize the dispatchers. So, I'll answer both.\n\n1) There are other ways such as by using a WaitableEvent, but this is a simpler way that doesn't require any additional synchronization objects to the thread itself. Also, it's really just two lines of code (well, two semicolons), so it's hard to beat with regards to simplicity. ;)\n\n2) The dispatchers are single threaded objects that perform most of their work on the audio thread (and correctly have a lot of DCHECKs to make sure it stays that way).  As such, they really must be torn down from that same thread to keep things robust.  Additionally, the map that holds onto the dispatchers does not have any lock to guard against multithreaded access, so it too must only be accessed from the audio thread, so the ","draft":false,"lineno":100,"date":"2011-12-07 12:26:44.224938","left":false}],"id":7044,"is_binary":false},"content/browser/renderer_host/media/media_stream_dispatcher_host_unittest.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":1,"messages":[],"id":7019,"is_binary":false},"content/browser/renderer_host/render_process_host_impl.cc":{"status":"M    ","num_chunks":5,"no_base_file":false,"property_changes":"","num_added":43,"num_removed":50,"messages":[],"id":7023,"is_binary":false},"media/audio/linux/audio_manager_linux.h":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":2,"num_removed":3,"messages":[],"id":7058,"is_binary":false},"media/audio/audio_output_proxy.cc":{"status":"M    ","num_chunks":2,"no_base_file":false,"property_changes":"","num_added":9,"num_removed":4,"messages":[{"author":"henrika","author_email":"henrika@chromium.org","text":"Have to trust you on this part. Don't know the details well enough to comment ;-)","draft":false,"lineno":92,"date":"2011-12-07 10:08:34.506089","left":false},{"author":"tommi","author_email":"tommi@chromium.org","text":"On 2011/12/07 10:08:34, henrika1 wrote:\n> Have to trust you on this part. Don't know the details well enough to comment\n> ;-)\n\nThe Mac, Wave and WASAPI implementations delete themselves by calling manager_->ReleaseOutputStream(this) and most (or even all?) input stream implementations use some form of \"self_deleter\" (see e.g. the Alsa implementation).\n\nSo, the post condition for Close() is that the caller must not touch the object again. This is also true in the implementation as it was, but instead of deleting the object straight away, it delayed it by posting a task to the message queue.  Doing so is however not necessary and has two downsides: It leaves the door open to flakiness, it can delay shutdown since the message queue has to keep running in order to delete the task.","draft":false,"lineno":92,"date":"2011-12-07 12:26:44.225826","left":false}],"id":7051,"is_binary":false},"content/browser/renderer_host/media/media_stream_manager.h":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":5,"num_removed":1,"messages":[],"id":7021,"is_binary":false},"content/browser/speech/speech_recognizer_unittest.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":6,"num_removed":4,"messages":[],"id":7033,"is_binary":false},"content/browser/renderer_host/media/media_stream_manager.cc":{"status":"M    ","num_chunks":3,"no_base_file":false,"property_changes":"","num_added":6,"num_removed":3,"messages":[],"id":7020,"is_binary":false}},"owner_email":"tommi@chromium.org","owner":"tommi","message":"Address comments from Avi","try_job_results":[],"created":"2011-12-06 15:49:35.508373","url":null,"num_comments":35,"modified":"2011-12-07 15:29:20.404623","patchset":7002,"issue":8818012}